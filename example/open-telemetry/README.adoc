= OpenTelemetry ShowCase for Almaraz
:toc:
:toclevels: 2
:imagesdir: ./docs/images


== Description

This is a showcase on how to get full observability into Almaraz by using OpenTelemetry solution for tracing and Spring-Boot Actuator exposing a Prometheus interface for metrics.


== ShowCase Architecture

The architecture would be as simple as possible for learning porposes. Almaraz example will use
link:https://github.com/open-telemetry/opentelemetry-java/[auto-intrumentation] (via Java Agent) to automatically recollect tracing data to be sent to the OpenTelemetry Collector using default OTLP protocol.
For metrics, the link:https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html[Spirng Boot Actuator] is used to generate several metrics on each exposed endpoint.
All tracing data will be exported to a Jaeger Backend but metric data would be exposed as a 'pull-based' exporter 'a la Prometheus'.
In addition the collector instance itself is another observable application and it will be reporting telemetry
information too.

Following the link:https://opentelemetry.io/docs/[OpenTelemetry logic architecture], we are going to split observability data into three independent flows, all of them recollected by the OTEL Collector who will export them to the selected backends. As local infrastructure solution, docker-compose is used and its design is link:./docker-compose.yaml[here].

=== Tracing Backend

As tracing backend, we offer:

. Jaeger: using Elasticsearch as storage backend.

  `docker-compose up -d elasticsearch jaeger-collector jaeger-agent jaeger-query`

. Tempo:

  `docker-compose up -d tempo`

=== Metrics Backend

Prometheus is going to be the metrics backend, and the used configuration could be read link:./configs/prometheus.yaml[here].



=== Logging Backend

Currently, it is not used in this showcase.


=== Open-Telemetry Collector

The chosen collector implementation is the Open Telemetry reference implementation. It could be find
link:https://github.com/open-telemetry/opentelemetry-collector[here]. And the used pipeline
configuration could be read link:./configs/otel-local-config.yaml[here].

```
 docker run --rm --network host -v "${REPO_PATH}/open-telemetry/configs/otel-local-config.yaml":/otel-local-config.yaml --name otelcol otel/opentelemetry-collector --config otel-local-config.yaml;
```

=== Almaraz Application Example

We are going to use link:../example[Almaraz Example] as an application for the Telemetry showcase.

First it is required to use the link:Open-Telemetry Java Agent[https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent-all.jar].

Lets go start it using:

```
cd ..
mvn build:image
cd open-telemetry
docker-compose up almaraz-example-app
```

For testing, use the requests proposed link:../README.md[here]. For example:

```
curl -v -X POST -H 'Content-Type: application/json' -d '{"name": "jorge", "country": "es"}' http://localhost:8080/api/users
```

Jaeger console:

image:ot-almaraz-example-success.png[]



```
curl -v -X POST -H 'Content-Type: application/json' -d '{"name": "jorge", "country": "spain"}' http://localhost:8080/api/users
```

Jaeger console:

image:ot-almaraz-example-error.png[]


